name: Reproduce JFrog Maven Bug (Action Pinning)
on: workflow_dispatch

jobs:
  # JOB 1: Test with default Maven 3.9.12 — PASSES if JFrog CLI is patched (RTECO-753)
  test-default-maven:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: '2.89.0'  # Pin to 2.89+ for Maven 3.9.12 fix (RTECO-753)
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Check JFrog CLI Version
        run: jf --version

      # Default setup uses the runner's Maven (3.9.12)
      - name: Setup Java 21 (Default Maven)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Check Maven Version
        run: mvn -version

      - name: Generate Project
        run: |
          mvn archetype:generate -DgroupId=com.jfrog.repro \
          -DartifactId=crash-test \
          -DarchetypeArtifactId=maven-archetype-quickstart \
          -DinteractiveMode=false

      - name: Configure Artifactory
        working-directory: ./crash-test
        run: jf mvn-config --repo-resolve-releases=libs-release --repo-resolve-snapshots=libs-snapshot

      - name: Run Build (Passes if CLI is patched for Maven 3.9.12)
        working-directory: ./crash-test
        run: jf mvn clean install

  # JOB 2: Fallback — verify with pinned Maven 3.9.11 (workaround)
  verify-fix:
    needs: test-default-maven
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: '2.89.0'  # Pin to 2.89+ for Maven 3.9.12 fix (RTECO-753)
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Check JFrog CLI Version
        run: jf --version

      # --- Workaround: Pinning Maven 3.9.11 using s4u action ---
      - name: Setup Java 21 & Maven 3.9.11
        uses: s4u/setup-maven-action@v1.18.0
        with:
          java-version: '21'
          java-distribution: 'temurin'
          maven-version: '3.9.11' # <--- This successfully forces the version

      - name: Check Maven Version
        run: mvn -version

      - name: Generate Project
        run: |
          mvn archetype:generate -DgroupId=com.jfrog.repro \
          -DartifactId=fix-test \
          -DarchetypeArtifactId=maven-archetype-quickstart \
          -DinteractiveMode=false

      - name: Configure Artifactory
        working-directory: ./fix-test
        run: jf mvn-config --repo-resolve-releases=libs-release --repo-resolve-snapshots=libs-snapshot

      - name: Run Build (Maven 3.9.11 workaround)
        working-directory: ./fix-test
        run: jf mvn clean install
