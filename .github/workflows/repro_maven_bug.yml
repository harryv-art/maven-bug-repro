name: Reproduce JFrog Maven Bug (Pinned Fix 3.9.11)
on: workflow_dispatch

jobs:
  # JOB 1: Reproduce the Crash (Uses Default Maven 3.9.12)
  reproduce-crash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Check Maven Version (Expect 3.9.12)
        run: mvn -version

      - name: Generate Project
        run: |
          mvn archetype:generate -DgroupId=com.jfrog.repro \
          -DartifactId=crash-test \
          -DarchetypeArtifactId=maven-archetype-quickstart \
          -DinteractiveMode=false

      - name: Configure Artifactory
        working-directory: ./crash-test
        run: jf mvn-config --repo-resolve-releases=libs-release --repo-resolve-snapshots=libs-snapshot

      - name: Run Build (Expect Failure)
        working-directory: ./crash-test
        run: jf mvn clean install

  # JOB 2: Verify the Fix (Manually Install Maven 3.9.11)
  verify-fix:
    needs: reproduce-crash
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # --- THE FIX: Manually Install Maven 3.9.11 ---
      - name: Install Maven 3.9.11
        run: |
          wget https://archive.apache.org/dist/maven/maven-3/3.9.11/binaries/apache-maven-3.9.11-bin.tar.gz
          tar -xvf apache-maven-3.9.11-bin.tar.gz
          echo "$(pwd)/apache-maven-3.9.11/bin" >> $GITHUB_PATH

      - name: Check Maven Version (Expect 3.9.11)
        run: mvn -version

      - name: Generate Project
        run: |
          mvn archetype:generate -DgroupId=com.jfrog.repro \
          -DartifactId=fix-test \
          -DarchetypeArtifactId=maven-archetype-quickstart \
          -DinteractiveMode=false

      - name: Configure Artifactory
        working-directory: ./fix-test
        run: jf mvn-config --repo-resolve-releases=libs-release --repo-resolve-snapshots=libs-snapshot

      - name: Run Build (Expect Success)
        working-directory: ./fix-test
        run: jf mvn clean install
